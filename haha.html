<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controller</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="joy.min.js"></script>
    <style>

        body {
            color:white;
            overflow: hidden;
            margin: 0;
            display: flex;
            height: 90vh;
            align-items: center;
            justify-content: space-between;
            flex-direction: column;
            background-image: url("k.png");
            background-repeat: repeat;
        }

        #joy {
            bottom: 0;
            position: fixed;
        }

        #text {
            display: flex;
            flex-direction: column;
            width: 90vw;
            align-items: center;
            height:40vh;
            justify-content: space-between;
            padding-top: 1em;
        }

        #dyno {
            image-rendering: pixelated;
            height:128px;
            width:128px;            
        }

        #reset {
            position: absolute;
            top:0;
            right:0
        }

        #quest {
            text-align: left;
            width: 100%;
        }
    </style>
</head>
<body>
    <button id="reset" onclick="reset()">X</button>
    <div id="text">
        <img id="dyno" src="/pirate.gif" >
        <div id="quest"></div>
        <div id="button">Ð©Ð° Ð¿Ð¾Ð³Ð¾Ð´ÑŒ!</div>
    </div>
    <div id="joy"></div>

    <script>
        let quest=document.getElementById("quest"),
            qColors = ['ðŸŸ¥', 'ðŸŸ¦', 'ðŸŸ©', 'ðŸŸ¨']

        //ÐÐ° ÐºÐ°ÐºÐ¾Ð¹ ÐºÐ½Ð¾Ð¿Ð¾Ñ‡ÐºÐµ ÑÑ‚Ð¾Ð¸Ð¼
        let button = document.getElementById("button"),
            btnColors = {
                red:"ÐºÑ€Ð°ÑÐ½ÑƒÑŽ",
                green:"Ð·ÐµÐ»ÐµÐ½ÑƒÑŽ",
                yellow:"Ð¶ÐµÐ»Ñ‚ÑƒÑŽ",
                blue:"ÑÐ¸Ð½ÑŽÑŽ"
            };
        
        //Ð£Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð´Ð¶Ð¾Ð¹ÑÑ‚Ð¸Ðº Ð²Ð½Ð¸Ð·
        let joystick = document.getElementById("joy")
        joystick.style.width=window.innerWidth+"px";
        joystick.style.height=window.innerWidth+"px";

        //ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ id Ñ…Ð¾ÑÑ‚Ð°
        if(!window.location.hash) window.location.replace("./")
        const id = window.location.hash.slice(1)

        // Ð—Ð°Ð¿Ñ€Ð°ÑˆÐ¸Ð²Ð°ÐµÐ¼ Ð½Ð¸Ðº
        let nickname = localStorage.getItem("nickname") || prompt("Nickname:") || Math.random().toString(16).substr(2, 8)
        localStorage.setItem("nickname", nickname)
        
        //ÐŸÐ¾Ð»
        let sex = localStorage.getItem("sex") || (confirm("ÐšÐ¾Ð½Ñ„ÐµÑ‚ÐºÑƒ Ð±ÑƒÐ´ÐµÑˆÑŒ?")?"female":"male");
        localStorage.setItem("sex", sex)

        // Ð Ð°Ð±Ð¾Ñ‚Ð°ÐµÐ¼ Ñ Ð¿Ð¸Ñ€Ð¾Ð¼
        var peer = new Peer({
            host:"peer.iky.su"
        })
        peer.on("open", (myid)=>{
            var conn = peer.connect(id)
            
            conn.on('open', function(){
                conn.send({event:"setnickname",data:{nickname, sex}});

                button.innerHTML=`Ð’Ñ‹ Ð½Ðµ Ð²Ñ‹Ñ€Ð±Ð°Ð»Ð¸ Ð¾Ñ‚Ð²ÐµÑ‚!`

                let move = {x:0,y:0},
                    onMove = false;
                var Joy = new JoyStick('joy', {}, ({x,y})=>{
                    move={x:(+x)/100,y:(+y)/100};
                    onMove = true
                });
                setInterval(()=>{
                    conn.send({event:"heartbeat",data:{ok:true}});
                },1000)
                setInterval(()=>{
                    if(move.x==0&&move.y==0){
                        if(onMove){
                            onMove=false
                            conn.send({event:"move",data:move});
                        }
                    }else{
                        conn.send({event:"move",data:move});
                    }
                }, 16)
            });
            conn.on("data", ({data, event})=>{
                switch (event) {
                    case "button":
                        if(data.color==-1){
                            button.innerHTML=`Ð’Ñ‹ Ð½Ðµ Ð²Ñ‹Ñ€Ð±Ð°Ð»Ð¸ Ð¾Ñ‚Ð²ÐµÑ‚!`
                        }else{
                            button.innerHTML=`Ð’Ñ‹ Ð²Ñ‹Ð±Ñ€Ð°Ð»Ð¸ <span style="color: ${data.color}">${btnColors[data.color]}</span> ÐºÐ½Ð¾Ð¿ÐºÑƒ!`
                        }
                        break;

                    case "question":
                        quest.innerText=data.question+"\n\n"+data.options.map((text, index)=>`${qColors[index]} ${text}`).join("\n")+`\n{${data?.answer?.join(", ")??"NULL"}}`;

                        break;

                    case "dyno":
                        document.getElementById("dyno").src = data.image
                        break;
                
                    default:
                        console.log(`UNKNOWN EVENT ${event}`)
                        console.log(data)
                        break;
                }
            })
            conn.on('close', ()=>{
                button.innerText="Ð¢Ñ‹ ÐºÐ°Ðº ÑƒÐ¼ÑƒÐ´Ñ€Ð¸Ð»ÑÑ Ð¿Ñ€Ð¾Ð¸Ð³Ñ€Ð°Ñ‚ÑŒ!?";
                quest.innerText="";
                joystick.remove()
                setTimeout(()=>{
                    window.location.reload()
                },1000)
            })
        })

        function reset() {
            localStorage.removeItem('nickname')
            localStorage.removeItem("sex")
            window.location.reload()
        }
        
        

    </script>
</body>
</html>